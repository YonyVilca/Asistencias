{% extends 'base.html' %}
{% block title %}Reportes{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">üìä Panel de Reportes</h2>

    <!-- Navegaci√≥n de secciones -->
    <div class="section-nav d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="cargar('diario', event)">üìÖ Diario</button>
        <button class="btn btn-primary" onclick="cargar('semanal', event)">üóìÔ∏è Semanal</button>
        
        <button class="btn btn-outline-secondary" onclick="cargar('por_usuario', event)">üë§ Por usuario</button>
    </div>

    <!-- Contenedor din√°mico -->
    <div id="contenedor">
        <div class="text-muted text-center py-4">Cargando m√≥dulo...</div>
    </div>
</div>

<script>
    function cargar(seccion, evento = null) {
        const contenedor = document.getElementById('contenedor');
        contenedor.innerHTML = '<div class="text-muted text-center py-4">‚è≥ Cargando...</div>';

        let endpoint = '';
        if (seccion === 'diario') endpoint = '/admin/api/resumen-diario/html';
        else if (seccion === 'semanal') endpoint = '/admin/api/resumen-semanal/html';
        else if (seccion === 'por_usuario') endpoint = '/admin/api/por-usuario/html';

        fetch(endpoint)
            .then(res => res.text())
            .then(html => {
                contenedor.innerHTML = html;
            })
            .catch(() => {
                contenedor.innerHTML = '<div class="alert alert-danger">Error al cargar la secci√≥n.</div>';
            });

        if (evento) {
            document.querySelectorAll(".section-nav .btn").forEach(btn => {
                btn.classList.remove("btn-primary");
                btn.classList.add("btn-outline-secondary");
            });
            evento.target.classList.remove("btn-outline-secondary");
            evento.target.classList.add("btn-primary");
        }
    }

    document.addEventListener("DOMContentLoaded", () => cargar('semanal'));

    document.addEventListener("change", function(e) {
        const contenedorUsuario = document.getElementById("tabla-asistencias-usuario");

        if (e.target && e.target.id === "usuario-select" || e.target.id === "mes-select") {
            const userSelect = document.getElementById("usuario-select");
            const mesSelect = document.getElementById("mes-select");

            if (!userSelect || !mesSelect || !contenedorUsuario) return;

            const userId = userSelect.value;
            const mes = mesSelect.value;

            if (!userId) {
                contenedorUsuario.innerHTML = '<div class="text-muted text-center">Seleccione un usuario para ver sus asistencias.</div>';
                return;
            }

            contenedorUsuario.innerHTML = '<div class="text-center text-muted">‚è≥ Cargando asistencias...</div>';

            fetch(`/admin/api/asistencias-usuario?usuario_id=${userId}&mes=${mes}`)
                .then(res => res.text())
                .then(html => contenedorUsuario.innerHTML = html)
                .catch(() => contenedorUsuario.innerHTML = '<div class="alert alert-danger">Error al cargar asistencias.</div>');
        }

        if (e.target && e.target.id === "selector-semana") {
            const semana = e.target.value;
            const mes = document.getElementById("selector-mes")?.value || new Date().toISOString().slice(0, 7);
            const contenedor = document.getElementById("contenedor");

            contenedor.innerHTML = '<div class="text-muted text-center p-4">‚è≥ Cargando resumen semanal...</div>';

            fetch(`/admin/api/resumen-semanal/html?mes=${mes}&semana=${semana}`)
                .then(res => res.text())
                .then(html => contenedor.innerHTML = html)
                .catch(() => contenedor.innerHTML = '<div class="alert alert-danger">Error al cargar resumen semanal.</div>');
        }

        if (e.target && e.target.id === "selector-mes") {
            const mes = e.target.value;
            const semana = document.getElementById("selector-semana")?.value || 1;
            const contenedor = document.getElementById("contenedor");

            contenedor.innerHTML = '<div class="text-muted text-center p-4">‚è≥ Cargando resumen semanal...</div>';

            fetch(`/admin/api/resumen-semanal/html?mes=${mes}&semana=${semana}`)
                .then(res => res.text())
                .then(html => contenedor.innerHTML = html)
                .catch(() => contenedor.innerHTML = '<div class="alert alert-danger">Error al cargar resumen semanal.</div>');
        }
    });
</script>
{% endblock %}
